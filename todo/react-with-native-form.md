Should be refactored! Many complexities that can probably be simplified.
